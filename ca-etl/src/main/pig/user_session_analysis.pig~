REGISTER /home/IMPETUS/asadani/codebase/rampup/sandbox/ca-etl/target/ca-etl-0.0.1-SNAPSHOT.jar;

FLAT_DATA = load '/home/asadani/rampup/output/days/*' USING PigStorage(',') AS (clientIPAddress:chararray, timestamp:chararray, zipcode:chararray, httpMethod:chararray, httpURL:chararray, userId:chararray, userAuthToken:chararray, userBrowser:chararray,  eventDate:chararray, eventMonth:chararray, eventYear:chararray);

FLAT_DATA_WITH_DATE = foreach FLAT_DATA generate clientIPAddress, timestamp, zipcode, httpMethod, httpURL, userId, userAuthToken, userBrowser, CONCAT(CONCAT(CONCAT((chararray)eventDate, '-'), (chararray)eventMonth, '-'), (chararray)eventYear) AS eventDateCon:chararray;

FLAT_DATA_WITH_DATE_ORDERED = ORDER FLAT_DATA_WITH_DATE BY timestamp ASC;

GROUPED_BY_USER_AUTH_TOKEN = GROUP FLAT_DATA_WITH_DATE_ORDERED BY (userAuthToken);

SESSION_DETAILS = FOREACH GROUPED_BY_USER_AUTH_TOKEN GENERATE com.asadani.ca.pig.udf.SessionAnalyzer(FLAT_DATA_WITH_DATE_ORDERED) AS session;


FOR_HBASE_STORAGE = FOREACH SESSION_DETAILS GENERATE session.rowkeyForOp as rowKey, session.refreshEventCount as refreshCnt, session.backEventCount as backCnt, session.sessionDuration as duration;

STORE FOR_HBASE_STORAGE INTO 'hbase://USER_SESSION_DETAILS' USING org.apache.pig.backend.hadoop.hbase.HBaseStorage ('Output_Session_Analysis:refreshCnt, Output_Session_Analysis:backCnt, Output_Session_Analysis:duration');
